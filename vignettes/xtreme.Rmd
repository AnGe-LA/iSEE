---
title: >
  Exploring `r Biocpkg("iSEE")`'s advanced features 
author:
- name: Federico Marini
  affiliation: 
  - &id1 Institute of Medical Biostatistics, Epidemiology and Informatics (IMBEI), Mainz
  - Center for Thrombosis and Hemostasis (CTH), Mainz
  email: marinif@uni-mainz.de
- name: Aaron Lun
  affiliation: 
  - &id2 Cancer Research UK Cambridge Institute, University of Cambridge
  email: aaron.lun@cruk.cam.ac.uk
- name: Charlotte Soneson
  affiliation: 
  - &id3 Institute of Molecular Life Sciences, University of Zurich
  - SIB Swiss Institute of Bioinformatics
  email: charlottesoneson@gmail.com
- name: Kevin Rue-Albrecht
  affiliation: 
  - &id4 Kennedy Institute of Rheumatology, University of Oxford,
    Headington, Oxford OX3 7FY, UK.
  email: kevin.rue-albrecht@kennedy.ox.ac.uk
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('iSEE')`"
output: 
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{iSEE Advanced Features}
  %\VignetteEncoding{UTF-8}  
  %\VignettePackage{iSEE}
  %\VignetteKeywords{GeneExpression, RNASeq, Sequencing, Visualization, QualityControl, GUI}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: iSEE.bib
---

**Compiled date**: `r Sys.Date()`

**Last edited**: 2018-03-08

**License**: `r packageDescription("iSEE")[["License"]]`

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  warning = FALSE,
  message = FALSE
)
stopifnot(requireNamespace("htmltools"))
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
sce <- readRDS("sce.rds")    
```

To load and attach the package to your current workspace, enter:

```{r library}
library(iSEE)
```

# Changing the default start configuration

The default start configuration with one plot of each type may not always be the most appropriate.
`iSEE` allows the user to programmatically modify the initial settings [@kra2018iSEE], avoiding the need to click through the choices to obtain the desired panel setup.
Almost every aspect of the initial app state can be customized, down to whether or not the parameter boxes are open or closed!

To demonstrate this feature, let's assume that we are only interested in feature assay plots.
The default set of panels can be changed via the `initialPanels` argument of the `iSEE` function call. 
Given a `SingleCellExperiment` or `SummarizedExperiment` object named `sce`, the following code opens an app with two adjacent feature assay plots. 

```{r init}
init <- DataFrame(
    Name = c("Feature assay plot 1", "Feature assay plot 2"),
    Width = c(6, 6)
)
app <- iSEE(sce, initialPanels = init)
```

The genes to show on the y-axis in the two plots can be specified via the `geneExprArgs` argument to `iSEE`. This is a `DataFrame`, specifying the initial parameters for each plot. 
In this case, we want to modify the `YAxis` and `YAxisFeatName` defaults for the two plots:

```{r fexArg}
fexArg <- featAssayPlotDefaults(sce, 2)
fexArg$YAxisFeatName <- c("0610009L18Rik", "0610009B22Rik")
app <- iSEE(sce, initialPanels = init, featAssayArgs = fexArg)
```

This will open the app with two feature assay plots, showing the selected genes. 
Of course, from this starting point, all the interactive functionality is still available, and new panels can be added, modified and linked via brushing. 
Users should refer to `?defaults` for the full list of values that can be specified in `iSEE`.

# Combining with `ExperimentHub`

Here we will use `r Biocpkg("iSEE")` to showcase a TCGA RNA-seq data set of `r Biocpkg("Rsubread")`-summarized raw count data for 7,706 tumor samples, represented as an `ExpressionSet`.
The R data representation was derived from GEO accession [GSE62944](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE62944).
It is here retrieved from the Bioconductor `r Biocpkg("ExperimentHub")`, immediately ready for post-processing and visualization.

```{r ExperimentHub, eval=FALSE}
library(ExperimentHub)
library(SingleCellExperiment)
library(irlba)
library(Rtsne)

ehub <- ExperimentHub()
eh1 <- ehub[["EH1"]] # an ExpressionSet
se1 <- as(eh1, "SummarizedExperiment")
sce1 <- as(se1, "SingleCellExperiment")
sce1 <- scater::runPCA(sce1, exprs_values = "exprs")
irlba_out <- irlba(assay(sce1, "exprs"))
tsne_out <- Rtsne(irlba_out$v, pca = FALSE, perplexity = 50, verbose = TRUE)
reducedDim(sce1, "TSNE") <- tsne_out$Y
```

To demonstrate a fully featured app, that also enables row data plot panels, let us add gene-level metadata.
For instance, the mean log~2~-transformed expression of each gene, the count of samples in which each gene was detected, and the proportion of samples in which each gene was detected :

```{r rowData_sce1, eval=FALSE}
num_detected <- rowSums(assay(sce1, "exprs") > 0)
rowData(sce1) <- DataFrame(
    mean_log_exprs = rowMeans(log2(assay(sce1, "exprs") + 1)),
    num_detected = num_detected,
    percent_detected = num_detected * 100 / ncol(sce1)
)
iSEE(sce1) 
```

# Using online file sharing systems

Active projects may require regular updates to the `SingleCellExperiment` object, that must be iteratively re-distributed to collaborators.
One possible choice is to store the up-to-date `SingleCellExperiment` object in a file produced by the `saveRDS` command, and to host this file in an online file sharing system.
Users may then download the file and launch the `iSEE` application, using the `r Biocpkg("BiocFileCache")` framework:

```{r bfcdownload, eval=FALSE}
library(BiocFileCache)
bfc <- BiocFileCache(ask=FALSE)
rpath <- bfcrpath(bfc, "https://my.file.sharing.website.com/path/to/RDS")
sce <- readRDS(rpath)
iSEE(sce) 
```

This will download the RDS file and cache it locally for further use.
Upon changes to the remote resource, the cached version can be updated using the `bfcupdate` function.

# Exploring mass cytometry data

The flexibility of the `iSEE` interface means that it can be used to explore a variety of data types that can be represented in tabular format. 
Here, we show how `iSEE` can be used to explore a mass cytometry (CyTOF) data set.
This data set was originally generated by @bodenmiller2012cytof and is available from the `r Biocpkg("HDCytoData")` package.

```{r cytof, eval=FALSE}
library(HDCytoData)
bcrxl <- Bodenmiller_BCR_XL_SE()
```

The data set contains 172,791 cells and 35 markers. 
We randomly select a subset of the data consisting of 5,000 cells, and apply an arcsinh transformation with cofactor 5 to the observed abundance measurements. 
We also need to transpose the `SummarizedExperiment` object to have cells as columns and markers (features) as rows.

```{r, eval=FALSE}
bcrxl <- SingleCellExperiment(
    assays = list(exprs = asinh(t(assay(bcrxl, "exprs"))/5)),
    colData = rowData(bcrxl),
    rowData = colData(bcrxl)
)
set.seed(123)
bcrxl <- bcrxl[, sample(seq_len(ncol(bcrxl)), 5000, replace = FALSE)]
```

Next, we apply $t$-SNE to get a two-dimensional representation of the cells (this takes a few minutes).

```{r, eval=FALSE}
bcrxl <- scater::runTSNE(bcrxl, ncomponents = 2, exprs_values = "exprs") 
```

The conventional method for analyzing cytometry experiments and identifying known cell populations involves constructing a collection of two-dimensional scatter plots, each visualizing the cells in the space of two of the measured markers. 
By successively selecting subsets of cells with specific patterns of marker abundance ("gating"), experienced users can assign cells to known populations. 
To mimic part of the original gating strategy from @bodenmiller2012cytof, we define a starting configuration for `iSEE` with five *Feature assay plots*, each showing two of the markers. 
Each plot is linked to the previous one with the brushing effect set to "Restrict", meaning that only the cells selected by point selection in the previous plot are shown in each plot.
We also include a *Reduced dimension plot*, in which the cells are colored by the automatic cluster assignment. 
The *Reduced dimension plot* receives a restricting brush from the last *Feature assay plot*, which means that only the points that are selected by brushing in the latter will be shown in the *Reduced dimension plot*.

The code below sets up the initial panel configuration and brushing relationships. 

```{r initialPanels_cytof, eval=FALSE}
initialPanels <- DataFrame(
    Name = c(paste("Feature assay plot", 1:5), "Reduced dimension plot 1"),
    Width = c(rep(3, 5), 5))

# Feature assay plots
fexArg <- featAssayPlotDefaults(bcrxl, 5)
fexArg$XAxis <- "Feature name"
fexArg$XAxisFeatName <- c("Cell_length", "CD3", "CD7", "CD3", "CD4")
fexArg$YAxisFeatName <- c("CD45", "CD20", "CD45", "CD33", "CD45")
fexArg$SelectByPlot <- c("", paste("Feature assay plot", 1:4))
fexArg$SelectEffect <- "Restrict"

# Reduced dimension plot
redArg <- redDimPlotDefaults(bcrxl, 1)
redArg$ColorBy <- "Column data"
redArg$ColorByColData <- "population_id"
redArg$SelectByPlot <- "Feature assay plot 5"
redArg$SelectEffect <- "Restrict"
```

We then start `iSEE` in this configuration:

```{r iSEE_cytof, eval=FALSE}
iSEE(bcrxl, initialPanels = initialPanels, featAssayArgs = fexArg, redDimArgs = redArg)
```

We can start brushing from the first feature assay plot to successively refine a cell subpopulation. 
Roughly following the gating strategy in @bodenmiller2012cytof, we select:

- cells with high CD45 expression in *Feature assay plot 1*,
- cells with low CD20 expression in *Feature assay plot 2*,
- cells with high CD7 expression in *Feature assay plot 3*, 
- and then cells with high CD3 and low CD33 expression in *Feature assay plot 4*.

We can then select either cells with high or low CD4 expression in *Feature assay plot 5*.
If we review the resulting subset of cells shown in the *Reduced dimension plot 1*, we can see that these are indeed the cells that were classified as CD4^+^ (or CD8^+^) T-cells by the `r Biocpkg("FlowSOM")` clustering that was applied to the original data set (included here as the `population_id` column). 

At this point, we can export all the code needed to reproduce the six panels by clicking on the **wrench** (<i class="fa fa-wrench"></i>) icon in the top right corner and selecting "Extract the R code". 

# Writing your own tour

By providing a data frame to the `tour` argument of `iSEE`, you can create your own tour that will start when the app is launched. 
The data frame should have two columns, `element` and `intro`:

```{r}
introtour <- read.delim(system.file("extdata/intro_firststeps.txt", package = "iSEE"), 
    sep = ";", header = TRUE)
head(introtour)
```

Each entry of the `element` column contains the name of a UI element in the application, prefixed by a hash sign (`#`).
The `intro` column contains the corresponding text (or basic HTML) that is to be shown at each step.

The simplest way to get started is to copy the `intro_firststeps.txt` file from the `inst/extdata` folder and edit it for your specific data set. 
More customized tours require some understanding of what the names of the UI elements are, for use in the `element` column.
We can recommend one of the following options:

- If using Firefox, open the `Tools` menu. 
Select `Web Developer`, and in the submenu, select `Inspector`. 
This will toggle a toolbar, and you will be able to read out the name of the element of interest when you hover and click on it. 
If you want to select another element, you might need to re-click on the icon in the upper left corner of the toolbox, `Pick an element from the page`.
- If using Safari, open the `Develop` menu and select `Show Web Inspector`. 
To toggle the selection of elements, you need to click on the crosshair icon in the top part of the toolbox, then again, explore the desired element by clicking or hovering on it.
- If using Chrome, from the `View` menu, select first `Developer` and then `Developer Tools`. 
Click then on the selecting arrow in the top left corner, and similarly to the other browsers, hover or click on the element of interest to obtain its name.
- Alternatively, the [SelectorGadget](https://selectorgadget.com) browser extension can be used.

Most elements can be picked in one of the above manner. 
Selectize widgets are trickier but can be handled with, e.g., `#heatMapPlot1_ColData + .selectize-control`.
Please see the `intro_firststeps.txt` file in the `inst/extdata` folder for more of these examples.

Sometimes it is useful to place one step of the tour in the center. 
To do so, simply put a hash sign before a word which does not link directly to any CSS selector (e.g., as we do for `#Welcome`) in the corresponding `element` column.

# Session Info {.unnumbered}

```{r sessioninfo}
sessionInfo()
# devtools::session_info()
```

# References {.unnumbered}

